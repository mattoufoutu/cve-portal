# -*- coding: utf-8 -*-

import cgi

from flask import Blueprint, render_template, jsonify
from flask.ext.login import login_required

from lib.utils import tracker

issues_blueprint = Blueprint('issues', __name__)


@issues_blueprint.route('/')
@login_required
def issues():
    return render_template('issues.html')


@issues_blueprint.route('/issuetab')
@login_required
def issuetab():
    data = {}
    issues = []
    total = 0
    for tracker_issue in tracker.issues:
        issue = {
            'id': tracker_issue.id,
            'url': tracker_issue.url,
            'cve': tracker_issue.cve,
            'cvss': tracker_issue.cvss,
            'vendor': tracker_issue.vendor,
            'product': tracker_issue.product,
            'version': tracker_issue.version
        }
        for k, v in issue.iteritems():
            if isinstance(v, basestring):
             issue[k] = cgi.escape(v, quote=True)
        issues.append(issue)
        total += 1
    data['total'] = total
    data['rows'] = issues
    return jsonify(data)
